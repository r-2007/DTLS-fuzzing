<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - trace.lcov_info_final - tinydtls-fuzz-cov/tests/dtls-server.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">tinydtls-fuzz-cov/tests</a> - dtls-server.c<span style="font-size: 80%;"> (source / <a href="dtls-server.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">trace.lcov_info_final</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">125</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-11-25 02:58:41</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">9</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntryHi">-</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : </a>
<span class="lineNum">       2 </span>                :            : /* This is needed for apple */
<span class="lineNum">       3 </span>                :            : #define __APPLE_USE_RFC_3542
<span class="lineNum">       4 </span>                :            : 
<span class="lineNum">       5 </span>                :            : #include &lt;assert.h&gt;
<span class="lineNum">       6 </span>                :            : #include &lt;stdio.h&gt;
<span class="lineNum">       7 </span>                :            : #include &lt;string.h&gt;
<span class="lineNum">       8 </span>                :            : #include &lt;errno.h&gt;
<span class="lineNum">       9 </span>                :            : #include &lt;unistd.h&gt;
<span class="lineNum">      10 </span>                :            : #include &lt;netinet/in.h&gt;
<span class="lineNum">      11 </span>                :            : #include &lt;sys/types.h&gt;
<span class="lineNum">      12 </span>                :            : #include &lt;sys/socket.h&gt;
<span class="lineNum">      13 </span>                :            : #include &lt;sys/time.h&gt;
<span class="lineNum">      14 </span>                :            : #include &lt;netdb.h&gt;
<span class="lineNum">      15 </span>                :            : #include &lt;signal.h&gt;
<span class="lineNum">      16 </span>                :            : 
<span class="lineNum">      17 </span>                :            : #include &quot;tinydtls.h&quot; 
<span class="lineNum">      18 </span>                :            : #include &quot;dtls.h&quot; 
<span class="lineNum">      19 </span>                :            : 
<span class="lineNum">      20 </span>                :            : /* Log configuration */
<span class="lineNum">      21 </span>                :            : #define LOG_MODULE &quot;dtls-server&quot;
<span class="lineNum">      22 </span>                :            : #define LOG_LEVEL  LOG_LEVEL_DTLS
<span class="lineNum">      23 </span>                :            : #include &quot;dtls-log.h&quot;
<span class="lineNum">      24 </span>                :            : 
<span class="lineNum">      25 </span>                :            : #define DEFAULT_PORT 20220
<span class="lineNum">      26 </span>                :            : 
<span class="lineNum">      27 </span>                :            : static const unsigned char ecdsa_priv_key[] = {
<span class="lineNum">      28 </span>                :            :                         0xD9, 0xE2, 0x70, 0x7A, 0x72, 0xDA, 0x6A, 0x05,
<span class="lineNum">      29 </span>                :            :                         0x04, 0x99, 0x5C, 0x86, 0xED, 0xDB, 0xE3, 0xEF,
<span class="lineNum">      30 </span>                :            :                         0xC7, 0xF1, 0xCD, 0x74, 0x83, 0x8F, 0x75, 0x70,
<span class="lineNum">      31 </span>                :            :                         0xC8, 0x07, 0x2D, 0x0A, 0x76, 0x26, 0x1B, 0xD4};
<span class="lineNum">      32 </span>                :            : 
<span class="lineNum">      33 </span>                :            : static const unsigned char ecdsa_pub_key_x[] = {
<span class="lineNum">      34 </span>                :            :                         0xD0, 0x55, 0xEE, 0x14, 0x08, 0x4D, 0x6E, 0x06,
<span class="lineNum">      35 </span>                :            :                         0x15, 0x59, 0x9D, 0xB5, 0x83, 0x91, 0x3E, 0x4A,
<span class="lineNum">      36 </span>                :            :                         0x3E, 0x45, 0x26, 0xA2, 0x70, 0x4D, 0x61, 0xF2,
<span class="lineNum">      37 </span>                :            :                         0x7A, 0x4C, 0xCF, 0xBA, 0x97, 0x58, 0xEF, 0x9A};
<span class="lineNum">      38 </span>                :            : 
<span class="lineNum">      39 </span>                :            : static const unsigned char ecdsa_pub_key_y[] = {
<span class="lineNum">      40 </span>                :            :                         0xB4, 0x18, 0xB6, 0x4A, 0xFE, 0x80, 0x30, 0xDA,
<span class="lineNum">      41 </span>                :            :                         0x1D, 0xDC, 0xF4, 0xF4, 0x2E, 0x2F, 0x26, 0x31,
<span class="lineNum">      42 </span>                :            :                         0xD0, 0x43, 0xB1, 0xFB, 0x03, 0xE2, 0x2F, 0x4D,
<span class="lineNum">      43 </span>                :            :                         0x17, 0xDE, 0x43, 0xF9, 0xF9, 0xAD, 0xEE, 0x70};
<span class="lineNum">      44 </span>                :            : 
<span class="lineNum">      45 </span>                :            : #if 0
<span class="lineNum">      46 </span>                :            : /* SIGINT handler: set quit to 1 for graceful termination */
<span class="lineNum">      47 </span>                :            : void
<span class="lineNum">      48 </span>                :            : handle_sigint(int signum) {
<span class="lineNum">      49 </span>                :            :   dsrv_stop(dsrv_get_context());
<span class="lineNum">      50 </span>                :            : }
<span class="lineNum">      51 </span>                :            : #endif
<span class="lineNum">      52 </span>                :            : #ifdef DTLS_PSK
<span class="lineNum">      53 </span>                :            : /* This function is the &quot;key store&quot; for tinyDTLS. It is called to
<span class="lineNum">      54 </span>                :            :  * retrieve a key for the given identity within this particular
<a name="55"><span class="lineNum">      55 </span>                :            :  * session. */</a>
<span class="lineNum">      56 </span>                :            : static int
<span class="lineNum">      57 </span>                :<span class="lineNoCov">          0 : get_psk_info(struct dtls_context_t *ctx, const session_t *session,</span>
<span class="lineNum">      58 </span>                :            :              dtls_credentials_type_t type,
<span class="lineNum">      59 </span>                :            :              const unsigned char *id, size_t id_len,
<span class="lineNum">      60 </span>                :            :              unsigned char *result, size_t result_length) {
<span class="lineNum">      61 </span>                :            : 
<span class="lineNum">      62 </span>                :            :   struct keymap_t {
<span class="lineNum">      63 </span>                :            :     unsigned char *id;
<span class="lineNum">      64 </span>                :            :     size_t id_length;
<span class="lineNum">      65 </span>                :            :     unsigned char *key;
<span class="lineNum">      66 </span>                :            :     size_t key_length;
<span class="lineNum">      67 </span>                :<span class="lineNoCov">          0 :   } psk[3] = {</span>
<span class="lineNum">      68 </span>                :            :     { (unsigned char *)&quot;Client_identity&quot;, 15,
<span class="lineNum">      69 </span>                :            :       (unsigned char *)&quot;\x12\x34&quot;, 2 }
<span class="lineNum">      70 </span>                :            :   };
<span class="lineNum">      71 </span>                :            : 
<span class="lineNum">      72 </span>                :<span class="lineNoCov">          0 :   if (type != DTLS_PSK_KEY) {</span>
<span class="lineNum">      73 </span>                :<span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">      74 </span>                :            :   }
<span class="lineNum">      75 </span>                :            : 
<span class="lineNum">      76 </span>                :<span class="lineNoCov">          0 :   if (id) {</span>
<span class="lineNum">      77 </span>                :            :     int i;
<span class="lineNum">      78 </span>                :<span class="lineNoCov">          0 :     for (i = 0; i &lt; sizeof(psk)/sizeof(struct keymap_t); i++) {</span>
<span class="lineNum">      79 </span>                :<span class="lineNoCov">          0 :       if (id_len == psk[i].id_length &amp;&amp; memcmp(id, psk[i].id, id_len) == 0) {</span>
<span class="lineNum">      80 </span>                :<span class="lineNoCov">          0 :         if (result_length &lt; psk[i].key_length) {</span>
<span class="lineNum">      81 </span>                :<span class="lineNoCov">          0 :           dtls_warn(&quot;buffer too small for PSK&quot;);</span>
<span class="lineNum">      82 </span>                :<span class="lineNoCov">          0 :           return dtls_alert_fatal_create(DTLS_ALERT_INTERNAL_ERROR);</span>
<span class="lineNum">      83 </span>                :            :         }
<span class="lineNum">      84 </span>                :            : 
<span class="lineNum">      85 </span>                :<span class="lineNoCov">          0 :         memcpy(result, psk[i].key, psk[i].key_length);</span>
<span class="lineNum">      86 </span>                :<span class="lineNoCov">          0 :         return psk[i].key_length;</span>
<span class="lineNum">      87 </span>                :            :       }
<span class="lineNum">      88 </span>                :            :     }
<span class="lineNum">      89 </span>                :            :   }
<span class="lineNum">      90 </span>                :            : 
<span class="lineNum">      91 </span>                :<span class="lineNoCov">          0 :   return dtls_alert_fatal_create(DTLS_ALERT_DECRYPT_ERROR);</span>
<span class="lineNum">      92 </span>                :            : }
<span class="lineNum">      93 </span>                :            : 
<span class="lineNum">      94 </span>                :            : #endif /* DTLS_PSK */
<span class="lineNum">      95 </span>                :            : 
<a name="96"><span class="lineNum">      96 </span>                :            : #ifdef DTLS_ECC</a>
<span class="lineNum">      97 </span>                :            : static int
<span class="lineNum">      98 </span>                :<span class="lineNoCov">          0 : get_ecdsa_key(struct dtls_context_t *ctx,</span>
<span class="lineNum">      99 </span>                :            :               const session_t *session,
<span class="lineNum">     100 </span>                :            :               const dtls_ecdsa_key_t **result) {
<span class="lineNum">     101 </span>                :            :   static const dtls_ecdsa_key_t ecdsa_key = {
<span class="lineNum">     102 </span>                :            :     .curve = DTLS_ECDH_CURVE_SECP256R1,
<span class="lineNum">     103 </span>                :            :     .priv_key = ecdsa_priv_key,
<span class="lineNum">     104 </span>                :            :     .pub_key_x = ecdsa_pub_key_x,
<span class="lineNum">     105 </span>                :            :     .pub_key_y = ecdsa_pub_key_y
<span class="lineNum">     106 </span>                :            :   };
<span class="lineNum">     107 </span>                :            : 
<span class="lineNum">     108 </span>                :<span class="lineNoCov">          0 :   *result = &amp;ecdsa_key;</span>
<span class="lineNum">     109 </span>                :<span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     110 </span>                :            : }
<a name="111"><span class="lineNum">     111 </span>                :            : </a>
<span class="lineNum">     112 </span>                :            : static int
<span class="lineNum">     113 </span>                :<span class="lineNoCov">          0 : verify_ecdsa_key(struct dtls_context_t *ctx,</span>
<span class="lineNum">     114 </span>                :            :                  const session_t *session,
<span class="lineNum">     115 </span>                :            :                  const unsigned char *other_pub_x,
<span class="lineNum">     116 </span>                :            :                  const unsigned char *other_pub_y,
<span class="lineNum">     117 </span>                :            :                  size_t key_size) {
<span class="lineNum">     118 </span>                :<span class="lineNoCov">          0 :   return 0;</span>
<span class="lineNum">     119 </span>                :            : }
<span class="lineNum">     120 </span>                :            : #endif /* DTLS_ECC */
<span class="lineNum">     121 </span>                :            : 
<span class="lineNum">     122 </span>                :            : #define DTLS_SERVER_CMD_CLOSE &quot;server:close&quot;
<span class="lineNum">     123 </span>                :            : #define DTLS_SERVER_CMD_RENEGOTIATE &quot;server:renegotiate&quot;
<a name="124"><span class="lineNum">     124 </span>                :            : </a>
<span class="lineNum">     125 </span>                :            : static int
<span class="lineNum">     126 </span>                :<span class="lineNoCov">          0 : read_from_peer(struct dtls_context_t *ctx, </span>
<span class="lineNum">     127 </span>                :            :                session_t *session, uint8_t *data, size_t len) {
<span class="lineNum">     128 </span>                :            :   size_t i;
<span class="lineNum">     129 </span>                :<span class="lineNoCov">          0 :   for (i = 0; i &lt; len; i++)</span>
<span class="lineNum">     130 </span>                :<span class="lineNoCov">          0 :     printf(&quot;%c&quot;, data[i]);</span>
<span class="lineNum">     131 </span>                :<span class="lineNoCov">          0 :   if (len &gt;= strlen(DTLS_SERVER_CMD_CLOSE) &amp;&amp;</span>
<span class="lineNum">     132 </span>                :<span class="lineNoCov">          0 :       !memcmp(data, DTLS_SERVER_CMD_CLOSE, strlen(DTLS_SERVER_CMD_CLOSE))) {</span>
<span class="lineNum">     133 </span>                :<span class="lineNoCov">          0 :     printf(&quot;server: closing connection\n&quot;);</span>
<span class="lineNum">     134 </span>                :<span class="lineNoCov">          0 :     dtls_close(ctx, session);</span>
<span class="lineNum">     135 </span>                :<span class="lineNoCov">          0 :     return len;</span>
<span class="lineNum">     136 </span>                :<span class="lineNoCov">          0 :   } else if (len &gt;= strlen(DTLS_SERVER_CMD_RENEGOTIATE) &amp;&amp;</span>
<span class="lineNum">     137 </span>                :<span class="lineNoCov">          0 :       !memcmp(data, DTLS_SERVER_CMD_RENEGOTIATE, strlen(DTLS_SERVER_CMD_RENEGOTIATE))) {</span>
<span class="lineNum">     138 </span>                :<span class="lineNoCov">          0 :     printf(&quot;server: renegotiate connection\n&quot;);</span>
<span class="lineNum">     139 </span>                :<span class="lineNoCov">          0 :     dtls_renegotiate(ctx, session);</span>
<span class="lineNum">     140 </span>                :<span class="lineNoCov">          0 :     return len;</span>
<span class="lineNum">     141 </span>                :            :   }
<span class="lineNum">     142 </span>                :            : 
<span class="lineNum">     143 </span>                :<span class="lineNoCov">          0 :   return dtls_write(ctx, session, data, len);</span>
<span class="lineNum">     144 </span>                :            : }
<a name="145"><span class="lineNum">     145 </span>                :            : </a>
<span class="lineNum">     146 </span>                :            : static int
<span class="lineNum">     147 </span>                :<span class="lineNoCov">          0 : send_to_peer(struct dtls_context_t *ctx, </span>
<span class="lineNum">     148 </span>                :            :              session_t *session, uint8_t *data, size_t len) {
<span class="lineNum">     149 </span>                :            : 
<span class="lineNum">     150 </span>                :<span class="lineNoCov">          0 :   int fd = *(int *)dtls_get_app_data(ctx);</span>
<span class="lineNum">     151 </span>                :<span class="lineNoCov">          0 :   return sendto(fd, data, len, MSG_DONTWAIT,</span>
<span class="lineNum">     152 </span>                :<span class="lineNoCov">          0 :                 &amp;session-&gt;addr.sa, session-&gt;size);</span>
<span class="lineNum">     153 </span>                :            : }
<a name="154"><span class="lineNum">     154 </span>                :            : </a>
<span class="lineNum">     155 </span>                :            : static int
<span class="lineNum">     156 </span>                :<span class="lineNoCov">          0 : dtls_handle_read(struct dtls_context_t *ctx) {</span>
<span class="lineNum">     157 </span>                :            :   int *fd;
<span class="lineNum">     158 </span>                :            :   session_t session;
<span class="lineNum">     159 </span>                :            :   static uint8_t buf[DTLS_MAX_BUF];
<span class="lineNum">     160 </span>                :            :   int len;
<span class="lineNum">     161 </span>                :            : 
<span class="lineNum">     162 </span>                :<span class="lineNoCov">          0 :   fd = dtls_get_app_data(ctx);</span>
<span class="lineNum">     163 </span>                :            : 
<span class="lineNum">     164 </span>                :<span class="lineNoCov">          0 :   assert(fd);</span>
<span class="lineNum">     165 </span>                :            : 
<span class="lineNum">     166 </span>                :<span class="lineNoCov">          0 :   memset(&amp;session, 0, sizeof(session_t));</span>
<span class="lineNum">     167 </span>                :<span class="lineNoCov">          0 :   session.size = sizeof(session.addr);</span>
<span class="lineNum">     168 </span>                :<span class="lineNoCov">          0 :   len = recvfrom(*fd, buf, sizeof(buf), MSG_TRUNC,</span>
<span class="lineNum">     169 </span>                :            :                  &amp;session.addr.sa, &amp;session.size);
<span class="lineNum">     170 </span>                :            : 
<span class="lineNum">     171 </span>                :<span class="lineNoCov">          0 :   if (len &lt; 0) {</span>
<span class="lineNum">     172 </span>                :<span class="lineNoCov">          0 :     perror(&quot;recvfrom&quot;);</span>
<span class="lineNum">     173 </span>                :<span class="lineNoCov">          0 :     return -1;</span>
<span class="lineNum">     174 </span>                :            :   } else {
<span class="lineNum">     175 </span>                :            :     dtls_debug(&quot;got %d bytes from port %d\n&quot;, len, 
<span class="lineNum">     176 </span>                :            :              ntohs(session.addr.sin6.sin6_port));
<span class="lineNum">     177 </span>                :<span class="lineNoCov">          0 :     if (sizeof(buf) &lt; len) {</span>
<span class="lineNum">     178 </span>                :<span class="lineNoCov">          0 :       dtls_warn(&quot;packet was truncated (%d bytes lost)\n&quot;, (int)(len - sizeof(buf)));</span>
<span class="lineNum">     179 </span>                :            :     }
<span class="lineNum">     180 </span>                :            :   }
<span class="lineNum">     181 </span>                :            : 
<span class="lineNum">     182 </span>                :<span class="lineNoCov">          0 :   return dtls_handle_message(ctx, &amp;session, buf, len);</span>
<span class="lineNum">     183 </span>                :            : }    
<a name="184"><span class="lineNum">     184 </span>                :            : </a>
<span class="lineNum">     185 </span>                :            : static int
<span class="lineNum">     186 </span>                :<span class="lineNoCov">          0 : resolve_address(const char *server, struct sockaddr *dst) {</span>
<span class="lineNum">     187 </span>                :            :   
<span class="lineNum">     188 </span>                :            :   struct addrinfo *res, *ainfo;
<span class="lineNum">     189 </span>                :            :   struct addrinfo hints;
<span class="lineNum">     190 </span>                :            :   static char addrstr[256];
<span class="lineNum">     191 </span>                :            :   int error;
<span class="lineNum">     192 </span>                :            : 
<span class="lineNum">     193 </span>                :<span class="lineNoCov">          0 :   memset(addrstr, 0, sizeof(addrstr));</span>
<span class="lineNum">     194 </span>                :<span class="lineNoCov">          0 :   if (server &amp;&amp; strlen(server) &gt; 0)</span>
<span class="lineNum">     195 </span>                :<span class="lineNoCov">          0 :     memcpy(addrstr, server, strlen(server));</span>
<span class="lineNum">     196 </span>                :            :   else
<span class="lineNum">     197 </span>                :<span class="lineNoCov">          0 :     memcpy(addrstr, &quot;localhost&quot;, 9);</span>
<span class="lineNum">     198 </span>                :            : 
<span class="lineNum">     199 </span>                :<span class="lineNoCov">          0 :   memset ((char *)&amp;hints, 0, sizeof(hints));</span>
<span class="lineNum">     200 </span>                :<span class="lineNoCov">          0 :   hints.ai_socktype = SOCK_DGRAM;</span>
<span class="lineNum">     201 </span>                :<span class="lineNoCov">          0 :   hints.ai_family = AF_UNSPEC;</span>
<span class="lineNum">     202 </span>                :            : 
<span class="lineNum">     203 </span>                :<span class="lineNoCov">          0 :   error = getaddrinfo(addrstr, &quot;&quot;, &amp;hints, &amp;res);</span>
<span class="lineNum">     204 </span>                :            : 
<span class="lineNum">     205 </span>                :<span class="lineNoCov">          0 :   if (error != 0) {</span>
<span class="lineNum">     206 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr, &quot;getaddrinfo: %s\n&quot;, gai_strerror(error));</span>
<span class="lineNum">     207 </span>                :<span class="lineNoCov">          0 :     return error;</span>
<span class="lineNum">     208 </span>                :            :   }
<span class="lineNum">     209 </span>                :            : 
<span class="lineNum">     210 </span>                :<span class="lineNoCov">          0 :   for (ainfo = res; ainfo != NULL; ainfo = ainfo-&gt;ai_next) {</span>
<span class="lineNum">     211 </span>                :            : 
<span class="lineNum">     212 </span>                :<span class="lineNoCov">          0 :     switch (ainfo-&gt;ai_family) {</span>
<span class="lineNum">     213 </span>                :<span class="lineNoCov">          0 :     case AF_INET6:</span>
<span class="lineNum">     214 </span>                :            : 
<span class="lineNum">     215 </span>                :<span class="lineNoCov">          0 :       memcpy(dst, ainfo-&gt;ai_addr, ainfo-&gt;ai_addrlen);</span>
<span class="lineNum">     216 </span>                :<span class="lineNoCov">          0 :       return ainfo-&gt;ai_addrlen;</span>
<span class="lineNum">     217 </span>                :<span class="lineNoCov">          0 :     default:</span>
<span class="lineNum">     218 </span>                :            :       ;
<span class="lineNum">     219 </span>                :            :     }
<span class="lineNum">     220 </span>                :            :   }
<span class="lineNum">     221 </span>                :            : 
<span class="lineNum">     222 </span>                :<span class="lineNoCov">          0 :   freeaddrinfo(res);</span>
<span class="lineNum">     223 </span>                :<span class="lineNoCov">          0 :   return -1;</span>
<span class="lineNum">     224 </span>                :            : }
<a name="225"><span class="lineNum">     225 </span>                :            : </a>
<span class="lineNum">     226 </span>                :            : static void
<span class="lineNum">     227 </span>                :<span class="lineNoCov">          0 : usage(const char *program, const char *version) {</span>
<span class="lineNum">     228 </span>                :            :   const char *p;
<span class="lineNum">     229 </span>                :            : 
<span class="lineNum">     230 </span>                :<span class="lineNoCov">          0 :   p = strrchr( program, '/' );</span>
<span class="lineNum">     231 </span>                :<span class="lineNoCov">          0 :   if ( p )</span>
<span class="lineNum">     232 </span>                :<span class="lineNoCov">          0 :     program = ++p;</span>
<span class="lineNum">     233 </span>                :            : 
<span class="lineNum">     234 </span>                :<span class="lineNoCov">          0 :   fprintf(stderr, &quot;%s v%s -- DTLS server implementation\n&quot;</span>
<span class="lineNum">     235 </span>                :            :           &quot;(c) 2011-2014 Olaf Bergmann &lt;bergmann@tzi.org&gt;\n\n&quot;
<span class="lineNum">     236 </span>                :            :           &quot;usage: %s [-A address] [-p port] [-v num]\n&quot;
<span class="lineNum">     237 </span>                :            :           &quot;\t-A address\t\tlisten on specified address (default is ::)\n&quot;
<span class="lineNum">     238 </span>                :            :           &quot;\t-p port\t\tlisten on specified port (default is %d)\n&quot;,
<span class="lineNum">     239 </span>                :            :            program, version, program, DEFAULT_PORT);
<span class="lineNum">     240 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     241 </span>                :            : 
<span class="lineNum">     242 </span>                :            : static dtls_handler_t cb = {
<span class="lineNum">     243 </span>                :            :   .write = send_to_peer,
<span class="lineNum">     244 </span>                :            :   .read  = read_from_peer,
<span class="lineNum">     245 </span>                :            :   .event = NULL,
<span class="lineNum">     246 </span>                :            : #ifdef DTLS_PSK
<span class="lineNum">     247 </span>                :            :   .get_psk_info = get_psk_info,
<span class="lineNum">     248 </span>                :            : #endif /* DTLS_PSK */
<span class="lineNum">     249 </span>                :            : #ifdef DTLS_ECC
<span class="lineNum">     250 </span>                :            :   .get_ecdsa_key = get_ecdsa_key,
<span class="lineNum">     251 </span>                :            :   .verify_ecdsa_key = verify_ecdsa_key
<span class="lineNum">     252 </span>                :            : #endif /* DTLS_ECC */
<span class="lineNum">     253 </span>                :            : };
<a name="254"><span class="lineNum">     254 </span>                :            : </a>
<span class="lineNum">     255 </span>                :            : int 
<span class="lineNum">     256 </span>                :<span class="lineNoCov">          0 : main(int argc, char **argv) {</span>
<span class="lineNum">     257 </span>                :<span class="lineNoCov">          0 :   dtls_context_t *the_context = NULL;</span>
<span class="lineNum">     258 </span>                :            :   fd_set rfds, wfds;
<span class="lineNum">     259 </span>                :            :   struct timeval timeout;
<span class="lineNum">     260 </span>                :            :   int fd, opt, result;
<span class="lineNum">     261 </span>                :<span class="lineNoCov">          0 :   int on = 1;</span>
<span class="lineNum">     262 </span>                :            :   struct sockaddr_in6 listen_addr;
<span class="lineNum">     263 </span>                :            : 
<span class="lineNum">     264 </span>                :<span class="lineNoCov">          0 :   memset(&amp;listen_addr, 0, sizeof(struct sockaddr_in6));</span>
<span class="lineNum">     265 </span>                :            : 
<span class="lineNum">     266 </span>                :            :   /* fill extra field for 4.4BSD-based systems (see RFC 3493, section 3.4) */
<span class="lineNum">     267 </span>                :            : #if defined(SIN6_LEN) || defined(HAVE_SOCKADDR_IN6_SIN6_LEN)
<span class="lineNum">     268 </span>                :            :   listen_addr.sin6_len = sizeof(struct sockaddr_in6);
<span class="lineNum">     269 </span>                :            : #endif
<span class="lineNum">     270 </span>                :            : 
<span class="lineNum">     271 </span>                :<span class="lineNoCov">          0 :   listen_addr.sin6_family = AF_INET6;</span>
<span class="lineNum">     272 </span>                :<span class="lineNoCov">          0 :   listen_addr.sin6_port = htons(DEFAULT_PORT);</span>
<span class="lineNum">     273 </span>                :<span class="lineNoCov">          0 :   listen_addr.sin6_addr = in6addr_any;</span>
<span class="lineNum">     274 </span>                :            : 
<span class="lineNum">     275 </span>                :<span class="lineNoCov">          0 :   while ((opt = getopt(argc, argv, &quot;A:p:&quot;)) != -1) {</span>
<span class="lineNum">     276 </span>                :<span class="lineNoCov">          0 :     switch (opt) {</span>
<span class="lineNum">     277 </span>                :<span class="lineNoCov">          0 :     case 'A' :</span>
<span class="lineNum">     278 </span>                :<span class="lineNoCov">          0 :       if (resolve_address(optarg, (struct sockaddr *)&amp;listen_addr) &lt; 0) {</span>
<span class="lineNum">     279 </span>                :<span class="lineNoCov">          0 :         fprintf(stderr, &quot;cannot resolve address\n&quot;);</span>
<span class="lineNum">     280 </span>                :<span class="lineNoCov">          0 :         exit(-1);</span>
<span class="lineNum">     281 </span>                :            :       }
<span class="lineNum">     282 </span>                :<span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     283 </span>                :<span class="lineNoCov">          0 :     case 'p' :</span>
<span class="lineNum">     284 </span>                :<span class="lineNoCov">          0 :       listen_addr.sin6_port = htons(atoi(optarg));</span>
<span class="lineNum">     285 </span>                :<span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     286 </span>                :<span class="lineNoCov">          0 :     default:</span>
<span class="lineNum">     287 </span>                :<span class="lineNoCov">          0 :       usage(argv[0], dtls_package_version());</span>
<span class="lineNum">     288 </span>                :<span class="lineNoCov">          0 :       exit(1);</span>
<span class="lineNum">     289 </span>                :            :     }
<span class="lineNum">     290 </span>                :            :   }
<span class="lineNum">     291 </span>                :            : 
<span class="lineNum">     292 </span>                :            :   /* init socket and set it to non-blocking */
<span class="lineNum">     293 </span>                :<span class="lineNoCov">          0 :   fd = socket(listen_addr.sin6_family, SOCK_DGRAM, 0);</span>
<span class="lineNum">     294 </span>                :            : 
<span class="lineNum">     295 </span>                :<span class="lineNoCov">          0 :   if (fd &lt; 0) {</span>
<span class="lineNum">     296 </span>                :<span class="lineNoCov">          0 :     dtls_alert(&quot;socket: %s\n&quot;, strerror(errno));</span>
<span class="lineNum">     297 </span>                :<span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">     298 </span>                :            :   }
<span class="lineNum">     299 </span>                :            : 
<span class="lineNum">     300 </span>                :<span class="lineNoCov">          0 :   if (setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &amp;on, sizeof(on) ) &lt; 0) {</span>
<span class="lineNum">     301 </span>                :<span class="lineNoCov">          0 :     dtls_alert(&quot;setsockopt SO_REUSEADDR: %s\n&quot;, strerror(errno));</span>
<span class="lineNum">     302 </span>                :            :   }
<span class="lineNum">     303 </span>                :            : #if 0
<span class="lineNum">     304 </span>                :            :   flags = fcntl(fd, F_GETFL, 0);
<span class="lineNum">     305 </span>                :            :   if (flags &lt; 0 || fcntl(fd, F_SETFL, flags | O_NONBLOCK) &lt; 0) {
<span class="lineNum">     306 </span>                :            :     dtls_alert(&quot;fcntl: %s\n&quot;, strerror(errno));
<span class="lineNum">     307 </span>                :            :     goto error;
<span class="lineNum">     308 </span>                :            :   }
<span class="lineNum">     309 </span>                :            : #endif
<span class="lineNum">     310 </span>                :<span class="lineNoCov">          0 :   on = 1;</span>
<span class="lineNum">     311 </span>                :            : #ifdef IPV6_RECVPKTINFO
<span class="lineNum">     312 </span>                :<span class="lineNoCov">          0 :   if (setsockopt(fd, IPPROTO_IPV6, IPV6_RECVPKTINFO, &amp;on, sizeof(on) ) &lt; 0) {</span>
<span class="lineNum">     313 </span>                :            : #else /* IPV6_RECVPKTINFO */
<span class="lineNum">     314 </span>                :            :   if (setsockopt(fd, IPPROTO_IPV6, IPV6_PKTINFO, &amp;on, sizeof(on) ) &lt; 0) {
<span class="lineNum">     315 </span>                :            : #endif /* IPV6_RECVPKTINFO */
<span class="lineNum">     316 </span>                :<span class="lineNoCov">          0 :     dtls_alert(&quot;setsockopt IPV6_PKTINFO: %s\n&quot;, strerror(errno));</span>
<span class="lineNum">     317 </span>                :            :   }
<span class="lineNum">     318 </span>                :            : 
<span class="lineNum">     319 </span>                :<span class="lineNoCov">          0 :   if (bind(fd, (struct sockaddr *)&amp;listen_addr, sizeof(listen_addr)) &lt; 0) {</span>
<span class="lineNum">     320 </span>                :<span class="lineNoCov">          0 :     dtls_alert(&quot;bind: %s\n&quot;, strerror(errno));</span>
<span class="lineNum">     321 </span>                :<span class="lineNoCov">          0 :     goto error;</span>
<span class="lineNum">     322 </span>                :            :   }
<span class="lineNum">     323 </span>                :            : 
<span class="lineNum">     324 </span>                :<span class="lineNoCov">          0 :   dtls_init();</span>
<span class="lineNum">     325 </span>                :            : 
<span class="lineNum">     326 </span>                :<span class="lineNoCov">          0 :   the_context = dtls_new_context(&amp;fd);</span>
<span class="lineNum">     327 </span>                :            : 
<span class="lineNum">     328 </span>                :<span class="lineNoCov">          0 :   dtls_set_handler(the_context, &amp;cb);</span>
<span class="lineNum">     329 </span>                :            : 
<span class="lineNum">     330 </span>                :            :   while (1) {
<span class="lineNum">     331 </span>                :<span class="lineNoCov">          0 :     FD_ZERO(&amp;rfds);</span>
<span class="lineNum">     332 </span>                :<span class="lineNoCov">          0 :     FD_ZERO(&amp;wfds);</span>
<span class="lineNum">     333 </span>                :            : 
<span class="lineNum">     334 </span>                :<span class="lineNoCov">          0 :     FD_SET(fd, &amp;rfds);</span>
<span class="lineNum">     335 </span>                :            :     /* FD_SET(fd, &amp;wfds); */
<span class="lineNum">     336 </span>                :            :     
<span class="lineNum">     337 </span>                :            :     /* Fuzzing edit: set DTLS retransmission timeout to long value) */
<span class="lineNum">     338 </span>                :<span class="lineNoCov">          0 :     timeout.tv_sec = 50000;</span>
<span class="lineNum">     339 </span>                :<span class="lineNoCov">          0 :     timeout.tv_usec = 0;</span>
<span class="lineNum">     340 </span>                :            :     
<span class="lineNum">     341 </span>                :<span class="lineNoCov">          0 :     result = select( fd+1, &amp;rfds, &amp;wfds, 0, &amp;timeout);</span>
<span class="lineNum">     342 </span>                :            :     
<span class="lineNum">     343 </span>                :<span class="lineNoCov">          0 :     if (result &lt; 0) {                /* error */</span>
<span class="lineNum">     344 </span>                :<span class="lineNoCov">          0 :       if (errno != EINTR)</span>
<span class="lineNum">     345 </span>                :<span class="lineNoCov">          0 :         perror(&quot;select&quot;);</span>
<span class="lineNum">     346 </span>                :<span class="lineNoCov">          0 :     } else if (result == 0) {   /* timeout */</span>
<span class="lineNum">     347 </span>                :            :     } else {                    /* ok */
<span class="lineNum">     348 </span>                :<span class="lineNoCov">          0 :       if (FD_ISSET(fd, &amp;wfds))</span>
<span class="lineNum">     349 </span>                :            :         ;
<span class="lineNum">     350 </span>                :<span class="lineNoCov">          0 :       else if (FD_ISSET(fd, &amp;rfds)) {</span>
<span class="lineNum">     351 </span>                :<span class="lineNoCov">          0 :         dtls_handle_read(the_context);</span>
<span class="lineNum">     352 </span>                :            :       }
<span class="lineNum">     353 </span>                :            :     }
<span class="lineNum">     354 </span>                :            :   }
<span class="lineNum">     355 </span>                :            :   
<span class="lineNum">     356 </span>                :<span class="lineNoCov">          0 :  error:</span>
<span class="lineNum">     357 </span>                :<span class="lineNoCov">          0 :   dtls_free_context(the_context);</span>
<span class="lineNum">     358 </span>                :<span class="lineNoCov">          0 :   exit(0);</span>
<span class="lineNum">     359 </span>                :            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
