<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - trace.lcov_info_final - tinydtls-fuzz-cov/ecc/ecc.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">tinydtls-fuzz-cov/ecc</a> - ecc.c<span style="font-size: 80%;"> (source / <a href="ecc.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">trace.lcov_info_final</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">282</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-11-25 04:00:18</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">23</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">156</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * Copyright (c) 2009 Chris K Cockrum &lt;ckc@cockrum.net&gt;
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * Copyright (c) 2013 Jens Trillmann &lt;jtrillma@tzi.de&gt;
<span class="lineNum">       5 </span>                :            :  * Copyright (c) 2013 Marc MÃ¼ller-Weinhardt &lt;muewei@tzi.de&gt;
<span class="lineNum">       6 </span>                :            :  * Copyright (c) 2013 Lars Schmertmann &lt;lars@tzi.de&gt;
<span class="lineNum">       7 </span>                :            :  * Copyright (c) 2013 Hauke Mehrtens &lt;hauke@hauke-m.de&gt;
<span class="lineNum">       8 </span>                :            :  *
<span class="lineNum">       9 </span>                :            :  * Permission is hereby granted, free of charge, to any person obtaining a copy
<span class="lineNum">      10 </span>                :            :  * of this software and associated documentation files (the &quot;Software&quot;), to deal
<span class="lineNum">      11 </span>                :            :  * in the Software without restriction, including without limitation the rights
<span class="lineNum">      12 </span>                :            :  * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
<span class="lineNum">      13 </span>                :            :  * copies of the Software, and to permit persons to whom the Software is
<span class="lineNum">      14 </span>                :            :  * furnished to do so, subject to the following conditions:
<span class="lineNum">      15 </span>                :            :  *
<span class="lineNum">      16 </span>                :            :  * The above copyright notice and this permission notice shall be included in
<span class="lineNum">      17 </span>                :            :  * all copies or substantial portions of the Software.
<span class="lineNum">      18 </span>                :            :  *
<span class="lineNum">      19 </span>                :            :  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
<span class="lineNum">      20 </span>                :            :  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
<span class="lineNum">      21 </span>                :            :  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
<span class="lineNum">      22 </span>                :            :  * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
<span class="lineNum">      23 </span>                :            :  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
<span class="lineNum">      24 </span>                :            :  * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
<span class="lineNum">      25 </span>                :            :  * THE SOFTWARE.
<span class="lineNum">      26 </span>                :            :  *
<span class="lineNum">      27 </span>                :            :  *
<span class="lineNum">      28 </span>                :            :  * This implementation is based in part on the paper Implementation of an
<span class="lineNum">      29 </span>                :            :  * Elliptic Curve Cryptosystem on an 8-bit Microcontroller [0] by
<span class="lineNum">      30 </span>                :            :  * Chris K Cockrum &lt;ckc@cockrum.net&gt;.
<span class="lineNum">      31 </span>                :            :  *
<span class="lineNum">      32 </span>                :            :  * [0]: http://cockrum.net/Implementation_of_ECC_on_an_8-bit_microcontroller.pdf
<span class="lineNum">      33 </span>                :            :  *
<span class="lineNum">      34 </span>                :            :  * This is a efficient ECC implementation on the secp256r1 curve for 32 Bit CPU
<span class="lineNum">      35 </span>                :            :  * architectures. It provides basic operations on the secp256r1 curve and support
<span class="lineNum">      36 </span>                :            :  * for ECDH and ECDSA.
<span class="lineNum">      37 </span>                :            :  */
<span class="lineNum">      38 </span>                :            : 
<span class="lineNum">      39 </span>                :            : //big number functions
<span class="lineNum">      40 </span>                :            : #include &quot;ecc.h&quot;
<a name="41"><span class="lineNum">      41 </span>                :            : #include &lt;string.h&gt;</a>
<span class="lineNum">      42 </span>                :            : 
<span class="lineNum">      43 </span>                :<span class="lineNoCov">          0 : static uint32_t add( const uint32_t *x, const uint32_t *y, uint32_t *result, uint8_t length){</span>
<span class="lineNum">      44 </span>                :<span class="lineNoCov">          0 :         uint64_t d = 0; //carry</span>
<span class="lineNum">      45 </span>                :<span class="lineNoCov">          0 :         int v = 0;</span>
<span class="lineNum">      46 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(v = 0;v&lt;length;v++){</span>
<span class="lineNum">      47 </span>                :            :                 //printf(&quot;%02x + %02x + %01x = &quot;, x[v], y[v], d);
<span class="lineNum">      48 </span>                :<span class="lineNoCov">          0 :                 d += (uint64_t) x[v] + (uint64_t) y[v];</span>
<span class="lineNum">      49 </span>                :            :                 //printf(&quot;%02x\n&quot;, d);
<span class="lineNum">      50 </span>                :<span class="lineNoCov">          0 :                 result[v] = d;</span>
<span class="lineNum">      51 </span>                :<span class="lineNoCov">          0 :                 d = d&gt;&gt;32; //save carry</span>
<span class="lineNum">      52 </span>                :            :         }
<span class="lineNum">      53 </span>                :            :         
<span class="lineNum">      54 </span>                :<span class="lineNoCov">          0 :         return (uint32_t)d;</span>
<a name="55"><span class="lineNum">      55 </span>                :            : }</a>
<span class="lineNum">      56 </span>                :            : 
<span class="lineNum">      57 </span>                :<span class="lineNoCov">          0 : static uint32_t sub( const uint32_t *x, const uint32_t *y, uint32_t *result, uint8_t length){</span>
<span class="lineNum">      58 </span>                :<span class="lineNoCov">          0 :         uint64_t d = 0;</span>
<span class="lineNum">      59 </span>                :            :         int v;
<span class="lineNum">      60 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(v = 0;v &lt; length; v++){</span>
<span class="lineNum">      61 </span>                :<span class="lineNoCov">          0 :                 d = (uint64_t) x[v] - (uint64_t) y[v] - d;</span>
<span class="lineNum">      62 </span>                :<span class="lineNoCov">          0 :                 result[v] = d &amp; 0xFFFFFFFF;</span>
<span class="lineNum">      63 </span>                :<span class="lineNoCov">          0 :                 d = d&gt;&gt;32;</span>
<span class="lineNum">      64 </span>                :<span class="lineNoCov">          0 :                 d &amp;= 0x1;</span>
<span class="lineNum">      65 </span>                :            :         }       
<span class="lineNum">      66 </span>                :<span class="lineNoCov">          0 :         return (uint32_t)d;</span>
<a name="67"><span class="lineNum">      67 </span>                :            : }</a>
<span class="lineNum">      68 </span>                :            : 
<span class="lineNum">      69 </span>                :<span class="lineNoCov">          0 : static void rshiftby(const uint32_t *in, uint8_t in_size, uint32_t *out, uint8_t out_size, uint8_t shift) {</span>
<span class="lineNum">      70 </span>                :            :         int i;
<span class="lineNum">      71 </span>                :            : 
<span class="lineNum">      72 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (i = 0; i &lt; (in_size - shift) &amp;&amp; i &lt; out_size; i++)</span>
<span class="lineNum">      73 </span>                :<span class="lineNoCov">          0 :                 out[i] = in[i + shift];</span>
<span class="lineNum">      74 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (/* reuse i */; i &lt; out_size; i++)</span>
<span class="lineNum">      75 </span>                :<span class="lineNoCov">          0 :                 out[i] = 0;</span>
<span class="lineNum">      76 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">      77 </span>                :            : 
<span class="lineNum">      78 </span>                :            : //finite field functions
<span class="lineNum">      79 </span>                :            : //FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF
<span class="lineNum">      80 </span>                :            : static const uint32_t ecc_prime_m[8] = {0xffffffff, 0xffffffff, 0xffffffff, 0x00000000,
<span class="lineNum">      81 </span>                :            :                                         0x00000000, 0x00000000, 0x00000001, 0xffffffff};
<span class="lineNum">      82 </span>                :            : 
<span class="lineNum">      83 </span>                :            :                                                         
<span class="lineNum">      84 </span>                :            : /* This is added after an static byte addition if the answer has a carry in MSB*/
<span class="lineNum">      85 </span>                :            : static const uint32_t ecc_prime_r[8] = {0x00000001, 0x00000000, 0x00000000, 0xffffffff,
<span class="lineNum">      86 </span>                :            :                                         0xffffffff, 0xffffffff, 0xfffffffe, 0x00000000};
<span class="lineNum">      87 </span>                :            : 
<span class="lineNum">      88 </span>                :            : // ffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551
<span class="lineNum">      89 </span>                :            : static const uint32_t ecc_order_m[9] = {0xFC632551, 0xF3B9CAC2, 0xA7179E84, 0xBCE6FAAD,
<span class="lineNum">      90 </span>                :            :                                         0xFFFFFFFF, 0xFFFFFFFF, 0x00000000, 0xFFFFFFFF,
<span class="lineNum">      91 </span>                :            :                                         0x00000000};
<span class="lineNum">      92 </span>                :            : 
<span class="lineNum">      93 </span>                :            : static const uint32_t ecc_order_r[8] = {0x039CDAAF, 0x0C46353D, 0x58E8617B, 0x43190552,
<span class="lineNum">      94 </span>                :            :                                         0x00000000, 0x00000000, 0xFFFFFFFF, 0x00000000};
<span class="lineNum">      95 </span>                :            : 
<span class="lineNum">      96 </span>                :            : static const uint32_t ecc_order_mu[9] = {0xEEDF9BFE, 0x012FFD85, 0xDF1A6C21, 0x43190552,
<span class="lineNum">      97 </span>                :            :                                          0xFFFFFFFF, 0xFFFFFFFE, 0xFFFFFFFF, 0x00000000,
<span class="lineNum">      98 </span>                :            :                                          0x00000001};
<span class="lineNum">      99 </span>                :            : 
<span class="lineNum">     100 </span>                :            : static const uint8_t ecc_order_k = 8;
<span class="lineNum">     101 </span>                :            : 
<span class="lineNum">     102 </span>                :            : const uint32_t ecc_g_point_x[8] = { 0xD898C296, 0xF4A13945, 0x2DEB33A0, 0x77037D81,
<span class="lineNum">     103 </span>                :            :                                     0x63A440F2, 0xF8BCE6E5, 0xE12C4247, 0x6B17D1F2};
<span class="lineNum">     104 </span>                :            : const uint32_t ecc_g_point_y[8] = { 0x37BF51F5, 0xCBB64068, 0x6B315ECE, 0x2BCE3357,
<span class="lineNum">     105 </span>                :            :                                     0x7C0F9E16, 0x8EE7EB4A, 0xFE1A7F9B, 0x4FE342E2};
<a name="106"><span class="lineNum">     106 </span>                :            : </a>
<span class="lineNum">     107 </span>                :            : 
<span class="lineNum">     108 </span>                :<span class="lineNoCov">          0 : static void setZero(uint32_t *A, const int length){</span>
<span class="lineNum">     109 </span>                :<span class="lineNoCov">          0 :         memset(A, 0x0, length * sizeof(uint32_t));</span>
<span class="lineNum">     110 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     111 </span>                :            : 
<span class="lineNum">     112 </span>                :            : /*
<a name="113"><span class="lineNum">     113 </span>                :            :  * copy one array to another</a>
<span class="lineNum">     114 </span>                :            :  */
<span class="lineNum">     115 </span>                :<span class="lineNoCov">          0 : static void copy(const uint32_t *from, uint32_t *to, uint8_t length){</span>
<span class="lineNum">     116 </span>                :<span class="lineNoCov">          0 :         memcpy(to, from, length * sizeof(uint32_t));</span>
<a name="117"><span class="lineNum">     117 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     118 </span>                :            : 
<span class="lineNum">     119 </span>                :<span class="lineNoCov">          0 : static int isSame(const uint32_t *A, const uint32_t *B, uint8_t length){</span>
<span class="lineNum">     120 </span>                :<span class="lineNoCov">          0 :         return !memcmp(A, B, length * sizeof(uint32_t));</span>
<span class="lineNum">     121 </span>                :            : }
<a name="122"><span class="lineNum">     122 </span>                :            : </a>
<span class="lineNum">     123 </span>                :            : //is A greater than B?
<span class="lineNum">     124 </span>                :<span class="lineNoCov">          0 : static int isGreater(const uint32_t *A, const uint32_t *B, uint8_t length){</span>
<span class="lineNum">     125 </span>                :            :         int i;
<span class="lineNum">     126 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (i = length-1; i &gt;= 0; --i)</span>
<span class="lineNum">     127 </span>                :            :         {
<span class="lineNum">     128 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(A[i] &gt; B[i])</span>
<span class="lineNum">     129 </span>                :<span class="lineNoCov">          0 :                         return 1;</span>
<span class="lineNum">     130 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(A[i] &lt; B[i])</span>
<span class="lineNum">     131 </span>                :<span class="lineNoCov">          0 :                         return -1;</span>
<span class="lineNum">     132 </span>                :            :         }
<span class="lineNum">     133 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     134 </span>                :            : }
<a name="135"><span class="lineNum">     135 </span>                :            : </a>
<span class="lineNum">     136 </span>                :            : 
<span class="lineNum">     137 </span>                :<span class="lineNoCov">          0 : static int fieldAdd(const uint32_t *x, const uint32_t *y, const uint32_t *reducer, uint32_t *result){</span>
<span class="lineNum">     138 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(add(x, y, result, arrayLength)){ //add prime if carry is still set!</span>
<span class="lineNum">     139 </span>                :            :                 uint32_t tempas[8];
<span class="lineNum">     140 </span>                :<span class="lineNoCov">          0 :                 setZero(tempas, 8);</span>
<span class="lineNum">     141 </span>                :<span class="lineNoCov">          0 :                 add(result, reducer, tempas, arrayLength);</span>
<span class="lineNum">     142 </span>                :<span class="lineNoCov">          0 :                 copy(tempas, result, arrayLength);</span>
<span class="lineNum">     143 </span>                :            :         }
<span class="lineNum">     144 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<a name="145"><span class="lineNum">     145 </span>                :            : }</a>
<span class="lineNum">     146 </span>                :            : 
<span class="lineNum">     147 </span>                :<span class="lineNoCov">          0 : static int fieldSub(const uint32_t *x, const uint32_t *y, const uint32_t *modulus, uint32_t *result){</span>
<span class="lineNum">     148 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(sub(x, y, result, arrayLength)){ //add modulus if carry is set</span>
<span class="lineNum">     149 </span>                :            :                 uint32_t tempas[8];
<span class="lineNum">     150 </span>                :<span class="lineNoCov">          0 :                 setZero(tempas, 8);</span>
<span class="lineNum">     151 </span>                :<span class="lineNoCov">          0 :                 add(result, modulus, tempas, arrayLength);</span>
<span class="lineNum">     152 </span>                :<span class="lineNoCov">          0 :                 copy(tempas, result, arrayLength);</span>
<span class="lineNum">     153 </span>                :            :         }
<span class="lineNum">     154 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     155 </span>                :            : }
<span class="lineNum">     156 </span>                :            : 
<a name="157"><span class="lineNum">     157 </span>                :            : //finite Field multiplication</a>
<span class="lineNum">     158 </span>                :            : //32bit * 32bit = 64bit
<span class="lineNum">     159 </span>                :<span class="lineNoCov">          0 : static int fieldMult(const uint32_t *x, const uint32_t *y, uint32_t *result, uint8_t length){</span>
<span class="lineNum">     160 </span>                :<span class="lineNoCov">          0 :         uint32_t temp[length * 2];</span>
<span class="lineNum">     161 </span>                :<span class="lineNoCov">          0 :         setZero(temp, length * 2);</span>
<span class="lineNum">     162 </span>                :<span class="lineNoCov">          0 :         setZero(result, length * 2);</span>
<span class="lineNum">     163 </span>                :            :         uint8_t k, n;
<span class="lineNum">     164 </span>                :            :         uint64_t l;
<span class="lineNum">     165 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (k = 0; k &lt; length; k++){</span>
<span class="lineNum">     166 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 for (n = 0; n &lt; length; n++){ </span>
<span class="lineNum">     167 </span>                :<span class="lineNoCov">          0 :                         l = (uint64_t)x[n]*(uint64_t)y[k];</span>
<span class="lineNum">     168 </span>                :<span class="lineNoCov">          0 :                         temp[n+k] = l&amp;0xFFFFFFFF;</span>
<span class="lineNum">     169 </span>                :<span class="lineNoCov">          0 :                         temp[n+k+1] = l&gt;&gt;32;</span>
<span class="lineNum">     170 </span>                :<span class="lineNoCov">          0 :                         add(&amp;temp[n+k], &amp;result[n+k], &amp;result[n+k], (length * 2) - (n + k));</span>
<span class="lineNum">     171 </span>                :            : 
<span class="lineNum">     172 </span>                :<span class="lineNoCov">          0 :                         setZero(temp, length * 2);</span>
<span class="lineNum">     173 </span>                :            :                 }
<span class="lineNum">     174 </span>                :            :         }
<span class="lineNum">     175 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     176 </span>                :            : }
<span class="lineNum">     177 </span>                :            : 
<a name="178"><span class="lineNum">     178 </span>                :            : //TODO: maximum:</a>
<span class="lineNum">     179 </span>                :            : //fffffffe00000002fffffffe0000000100000001fffffffe00000001fffffffe00000001fffffffefffffffffffffffffffffffe000000000000000000000001_16
<span class="lineNum">     180 </span>                :<span class="lineNoCov">          0 : static void fieldModP(uint32_t *A, const uint32_t *B)</span>
<span class="lineNum">     181 </span>                :            : {
<span class="lineNum">     182 </span>                :            :         uint32_t tempm[8];
<span class="lineNum">     183 </span>                :            :         uint32_t tempm2[8];
<span class="lineNum">     184 </span>                :            :         uint8_t n;
<span class="lineNum">     185 </span>                :<span class="lineNoCov">          0 :         setZero(tempm, 8);</span>
<span class="lineNum">     186 </span>                :<span class="lineNoCov">          0 :         setZero(tempm2, 8);</span>
<span class="lineNum">     187 </span>                :            :         /* A = T */ 
<span class="lineNum">     188 </span>                :<span class="lineNoCov">          0 :         copy(B,A,arrayLength);</span>
<span class="lineNum">     189 </span>                :            : 
<span class="lineNum">     190 </span>                :            :         /* Form S1 */ 
<span class="lineNum">     191 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=0;n&lt;3;n++) tempm[n]=0; </span>
<span class="lineNum">     192 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=3;n&lt;8;n++) tempm[n]=B[n+8];</span>
<span class="lineNum">     193 </span>                :            : 
<span class="lineNum">     194 </span>                :            :         /* tempm2=T+S1 */ 
<span class="lineNum">     195 </span>                :<span class="lineNoCov">          0 :         fieldAdd(A,tempm,ecc_prime_r,tempm2);</span>
<span class="lineNum">     196 </span>                :            :         /* A=T+S1+S1 */ 
<span class="lineNum">     197 </span>                :<span class="lineNoCov">          0 :         fieldAdd(tempm2,tempm,ecc_prime_r,A);</span>
<span class="lineNum">     198 </span>                :            :         /* Form S2 */ 
<span class="lineNum">     199 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=0;n&lt;3;n++) tempm[n]=0; </span>
<span class="lineNum">     200 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=3;n&lt;7;n++) tempm[n]=B[n+9]; </span>
<span class="lineNum">     201 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=7;n&lt;8;n++) tempm[n]=0;</span>
<span class="lineNum">     202 </span>                :            :         /* tempm2=T+S1+S1+S2 */ 
<span class="lineNum">     203 </span>                :<span class="lineNoCov">          0 :         fieldAdd(A,tempm,ecc_prime_r,tempm2);</span>
<span class="lineNum">     204 </span>                :            :         /* A=T+S1+S1+S2+S2 */ 
<span class="lineNum">     205 </span>                :<span class="lineNoCov">          0 :         fieldAdd(tempm2,tempm,ecc_prime_r,A);</span>
<span class="lineNum">     206 </span>                :            :         /* Form S3 */ 
<span class="lineNum">     207 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=0;n&lt;3;n++) tempm[n]=B[n+8]; </span>
<span class="lineNum">     208 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=3;n&lt;6;n++) tempm[n]=0; </span>
<span class="lineNum">     209 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=6;n&lt;8;n++) tempm[n]=B[n+8];</span>
<span class="lineNum">     210 </span>                :            :         /* tempm2=T+S1+S1+S2+S2+S3 */ 
<span class="lineNum">     211 </span>                :<span class="lineNoCov">          0 :         fieldAdd(A,tempm,ecc_prime_r,tempm2);</span>
<span class="lineNum">     212 </span>                :            :         /* Form S4 */ 
<span class="lineNum">     213 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=0;n&lt;3;n++) tempm[n]=B[n+9]; </span>
<span class="lineNum">     214 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=3;n&lt;6;n++) tempm[n]=B[n+10]; </span>
<span class="lineNum">     215 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=6;n&lt;7;n++) tempm[n]=B[n+7]; </span>
<span class="lineNum">     216 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=7;n&lt;8;n++) tempm[n]=B[n+1];</span>
<span class="lineNum">     217 </span>                :            :         /* A=T+S1+S1+S2+S2+S3+S4 */ 
<span class="lineNum">     218 </span>                :<span class="lineNoCov">          0 :         fieldAdd(tempm2,tempm,ecc_prime_r,A);</span>
<span class="lineNum">     219 </span>                :            :         /* Form D1 */ 
<span class="lineNum">     220 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=0;n&lt;3;n++) tempm[n]=B[n+11]; </span>
<span class="lineNum">     221 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=3;n&lt;6;n++) tempm[n]=0; </span>
<span class="lineNum">     222 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=6;n&lt;7;n++) tempm[n]=B[n+2]; </span>
<span class="lineNum">     223 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=7;n&lt;8;n++) tempm[n]=B[n+3];</span>
<span class="lineNum">     224 </span>                :            :         /* tempm2=T+S1+S1+S2+S2+S3+S4-D1 */ 
<span class="lineNum">     225 </span>                :<span class="lineNoCov">          0 :         fieldSub(A,tempm,ecc_prime_m,tempm2);</span>
<span class="lineNum">     226 </span>                :            :         /* Form D2 */ 
<span class="lineNum">     227 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=0;n&lt;4;n++) tempm[n]=B[n+12]; </span>
<span class="lineNum">     228 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=4;n&lt;6;n++) tempm[n]=0; </span>
<span class="lineNum">     229 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=6;n&lt;7;n++) tempm[n]=B[n+3]; </span>
<span class="lineNum">     230 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=7;n&lt;8;n++) tempm[n]=B[n+4];</span>
<span class="lineNum">     231 </span>                :            :         /* A=T+S1+S1+S2+S2+S3+S4-D1-D2 */ 
<span class="lineNum">     232 </span>                :<span class="lineNoCov">          0 :         fieldSub(tempm2,tempm,ecc_prime_m,A);</span>
<span class="lineNum">     233 </span>                :            :         /* Form D3 */ 
<span class="lineNum">     234 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=0;n&lt;3;n++) tempm[n]=B[n+13]; </span>
<span class="lineNum">     235 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=3;n&lt;6;n++) tempm[n]=B[n+5]; </span>
<span class="lineNum">     236 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=6;n&lt;7;n++) tempm[n]=0; </span>
<span class="lineNum">     237 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=7;n&lt;8;n++) tempm[n]=B[n+5];</span>
<span class="lineNum">     238 </span>                :            :         /* tempm2=T+S1+S1+S2+S2+S3+S4-D1-D2-D3 */ 
<span class="lineNum">     239 </span>                :<span class="lineNoCov">          0 :         fieldSub(A,tempm,ecc_prime_m,tempm2);</span>
<span class="lineNum">     240 </span>                :            :         /* Form D4 */ 
<span class="lineNum">     241 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=0;n&lt;2;n++) tempm[n]=B[n+14]; </span>
<span class="lineNum">     242 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=2;n&lt;3;n++) tempm[n]=0; </span>
<span class="lineNum">     243 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=3;n&lt;6;n++) tempm[n]=B[n+6]; </span>
<span class="lineNum">     244 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=6;n&lt;7;n++) tempm[n]=0; </span>
<span class="lineNum">     245 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=7;n&lt;8;n++) tempm[n]=B[n+6];</span>
<span class="lineNum">     246 </span>                :            :         /* A=T+S1+S1+S2+S2+S3+S4-D1-D2-D3-D4 */ 
<span class="lineNum">     247 </span>                :<span class="lineNoCov">          0 :         fieldSub(tempm2,tempm,ecc_prime_m,A);</span>
<span class="lineNum">     248 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(isGreater(A, ecc_prime_m, arrayLength) &gt;= 0){</span>
<span class="lineNum">     249 </span>                :<span class="lineNoCov">          0 :                 fieldSub(A, ecc_prime_m, ecc_prime_m, tempm);</span>
<span class="lineNum">     250 </span>                :<span class="lineNoCov">          0 :                 copy(tempm, A, arrayLength);</span>
<span class="lineNum">     251 </span>                :            :         }
<span class="lineNum">     252 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     253 </span>                :            : 
<span class="lineNum">     254 </span>                :            : /**
<span class="lineNum">     255 </span>                :            :  * calculate the result = A mod n.
<span class="lineNum">     256 </span>                :            :  * n is the order of the eliptic curve.
<span class="lineNum">     257 </span>                :            :  * A and result could point to the same value
<span class="lineNum">     258 </span>                :            :  *
<span class="lineNum">     259 </span>                :            :  * A: input value (max size * 4 bytes)
<span class="lineNum">     260 </span>                :            :  * result: result of modulo calculation (max 36 bytes)
<span class="lineNum">     261 </span>                :            :  * size: size of A
<span class="lineNum">     262 </span>                :            :  *
<span class="lineNum">     263 </span>                :            :  * This uses the Barrett modular reduction as described in the Handbook 
<span class="lineNum">     264 </span>                :            :  * of Applied Cryptography 14.42 Algorithm Barrett modular reduction, 
<span class="lineNum">     265 </span>                :            :  * see http://cacr.uwaterloo.ca/hac/about/chap14.pdf and 
<span class="lineNum">     266 </span>                :            :  * http://everything2.com/title/Barrett+Reduction
<span class="lineNum">     267 </span>                :            :  *
<span class="lineNum">     268 </span>                :            :  * b = 32 (bite size of the processor architecture)
<a name="269"><span class="lineNum">     269 </span>                :            :  * mu (ecc_order_mu) was precomputed in a java program</a>
<span class="lineNum">     270 </span>                :            :  */
<span class="lineNum">     271 </span>                :<span class="lineNoCov">          0 : static void fieldModO(const uint32_t *A, uint32_t *result, uint8_t length) {</span>
<span class="lineNum">     272 </span>                :            :         // This is used for value q1 and q3
<span class="lineNum">     273 </span>                :            :         uint32_t q1_q3[9];
<span class="lineNum">     274 </span>                :            :         // This is used for q2 and a temp var
<span class="lineNum">     275 </span>                :            :         uint32_t q2_tmp[18];
<span class="lineNum">     276 </span>                :            : 
<span class="lineNum">     277 </span>                :            :         // return if the given value is smaller than the modulus
<span class="lineNum">     278 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (length == arrayLength &amp;&amp; isGreater(A, ecc_order_m, arrayLength) &lt;= 0) {</span>
<span class="lineNum">     279 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (A != result)</span>
<span class="lineNum">     280 </span>                :<span class="lineNoCov">          0 :                         copy(A, result, length);</span>
<span class="lineNum">     281 </span>                :<span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     282 </span>                :            :         }
<span class="lineNum">     283 </span>                :            : 
<span class="lineNum">     284 </span>                :<span class="lineNoCov">          0 :         rshiftby(A, length, q1_q3, 9, ecc_order_k - 1);</span>
<span class="lineNum">     285 </span>                :            : 
<span class="lineNum">     286 </span>                :<span class="lineNoCov">          0 :         fieldMult(ecc_order_mu, q1_q3, q2_tmp, 9);</span>
<span class="lineNum">     287 </span>                :            : 
<span class="lineNum">     288 </span>                :<span class="lineNoCov">          0 :         rshiftby(q2_tmp, 18, q1_q3, 8, ecc_order_k + 1);</span>
<span class="lineNum">     289 </span>                :            : 
<span class="lineNum">     290 </span>                :            :         // r1 = first 9 blocks of A
<span class="lineNum">     291 </span>                :            : 
<span class="lineNum">     292 </span>                :<span class="lineNoCov">          0 :         fieldMult(q1_q3, ecc_order_m, q2_tmp, 8);</span>
<span class="lineNum">     293 </span>                :            : 
<span class="lineNum">     294 </span>                :            :         // r2 = first 9 blocks of q2_tmp
<span class="lineNum">     295 </span>                :            : 
<span class="lineNum">     296 </span>                :<span class="lineNoCov">          0 :         sub(A, q2_tmp, result, 9);</span>
<span class="lineNum">     297 </span>                :            : 
<span class="lineNum">     298 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while (isGreater(result, ecc_order_m, 9) &gt;= 0)</span>
<span class="lineNum">     299 </span>                :<span class="lineNoCov">          0 :                 sub(result, ecc_order_m, result, 9);</span>
<a name="300"><span class="lineNum">     300 </span>                :            : }</a>
<span class="lineNum">     301 </span>                :            : 
<span class="lineNum">     302 </span>                :<span class="lineNoCov">          0 : static int isOne(const uint32_t* A){</span>
<span class="lineNum">     303 </span>                :            :         uint8_t n; 
<span class="lineNum">     304 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=1;n&lt;8;n++) </span>
<span class="lineNum">     305 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (A[n]!=0) </span>
<span class="lineNum">     306 </span>                :<span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     307 </span>                :            : 
<span class="lineNum">     308 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((n==8)&amp;&amp;(A[0]==1)) </span>
<span class="lineNum">     309 </span>                :<span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">     310 </span>                :            :         else 
<span class="lineNum">     311 </span>                :<span class="lineNoCov">          0 :                 return 0;</span>
<a name="312"><span class="lineNum">     312 </span>                :            : }</a>
<span class="lineNum">     313 </span>                :            : 
<span class="lineNum">     314 </span>                :<span class="lineNoCov">          0 : static int isZero(const uint32_t* A){</span>
<span class="lineNum">     315 </span>                :<span class="lineNoCov">          0 :         uint8_t n, r=0;</span>
<span class="lineNum">     316 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(n=0;n&lt;8;n++){</span>
<span class="lineNum">     317 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (A[n] == 0) r++;</span>
<span class="lineNum">     318 </span>                :            :         }
<span class="lineNum">     319 </span>                :<span class="lineNoCov">          0 :         return r==8;</span>
<a name="320"><span class="lineNum">     320 </span>                :            : }</a>
<span class="lineNum">     321 </span>                :            : 
<span class="lineNum">     322 </span>                :<span class="lineNoCov">          0 : static void rshift(uint32_t* A){</span>
<span class="lineNum">     323 </span>                :            :         int n, i;
<span class="lineNum">     324 </span>                :<span class="lineNoCov">          0 :         uint32_t nOld = 0;</span>
<span class="lineNum">     325 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (i = 8; i--;)</span>
<span class="lineNum">     326 </span>                :            :         {
<span class="lineNum">     327 </span>                :<span class="lineNoCov">          0 :                 n = A[i]&amp;0x1;</span>
<span class="lineNum">     328 </span>                :<span class="lineNoCov">          0 :                 A[i] = A[i]&gt;&gt;1 | nOld&lt;&lt;31;</span>
<span class="lineNum">     329 </span>                :<span class="lineNoCov">          0 :                 nOld = n;</span>
<span class="lineNum">     330 </span>                :            :         }
<a name="331"><span class="lineNum">     331 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     332 </span>                :            : 
<span class="lineNum">     333 </span>                :<span class="lineNoCov">          0 : static int fieldAddAndDivide(const uint32_t *x, const uint32_t *modulus, const uint32_t *reducer, uint32_t* result){</span>
<span class="lineNum">     334 </span>                :<span class="lineNoCov">          0 :         uint32_t n = add(x, modulus, result, arrayLength);</span>
<span class="lineNum">     335 </span>                :<span class="lineNoCov">          0 :         rshift(result);</span>
<span class="lineNum">     336 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(n){ //add prime if carry is still set!</span>
<span class="lineNum">     337 </span>                :<span class="lineNoCov">          0 :                 result[7] |= 0x80000000;//add the carry</span>
<span class="lineNum">     338 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (isGreater(result, modulus, arrayLength) == 1)</span>
<span class="lineNum">     339 </span>                :            :                 {
<span class="lineNum">     340 </span>                :            :                         uint32_t tempas[8];
<span class="lineNum">     341 </span>                :<span class="lineNoCov">          0 :                         setZero(tempas, 8);</span>
<span class="lineNum">     342 </span>                :<span class="lineNoCov">          0 :                         add(result, reducer, tempas, 8);</span>
<span class="lineNum">     343 </span>                :<span class="lineNoCov">          0 :                         copy(tempas, result, arrayLength);</span>
<span class="lineNum">     344 </span>                :            :                 }
<span class="lineNum">     345 </span>                :            :                 
<span class="lineNum">     346 </span>                :            :         }
<span class="lineNum">     347 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     348 </span>                :            : }
<span class="lineNum">     349 </span>                :            : 
<span class="lineNum">     350 </span>                :            : /*
<a name="351"><span class="lineNum">     351 </span>                :            :  * Inverse A and output to B</a>
<span class="lineNum">     352 </span>                :            :  */
<span class="lineNum">     353 </span>                :<span class="lineNoCov">          0 : static void fieldInv(const uint32_t *A, const uint32_t *modulus, const uint32_t *reducer, uint32_t *B){</span>
<span class="lineNum">     354 </span>                :            :         uint32_t u[8],v[8],x1[8],x2[8];
<span class="lineNum">     355 </span>                :            :         uint32_t tempm[8];
<span class="lineNum">     356 </span>                :            :         uint32_t tempm2[8];
<span class="lineNum">     357 </span>                :<span class="lineNoCov">          0 :         setZero(tempm, 8);</span>
<span class="lineNum">     358 </span>                :<span class="lineNoCov">          0 :         setZero(tempm2, 8);</span>
<span class="lineNum">     359 </span>                :<span class="lineNoCov">          0 :         setZero(u, 8);</span>
<span class="lineNum">     360 </span>                :<span class="lineNoCov">          0 :         setZero(v, 8);</span>
<span class="lineNum">     361 </span>                :            : 
<span class="lineNum">     362 </span>                :            :         uint8_t t;
<span class="lineNum">     363 </span>                :<span class="lineNoCov">          0 :         copy(A,u,arrayLength); </span>
<span class="lineNum">     364 </span>                :<span class="lineNoCov">          0 :         copy(modulus,v,arrayLength); </span>
<span class="lineNum">     365 </span>                :<span class="lineNoCov">          0 :         setZero(x1, 8);</span>
<span class="lineNum">     366 </span>                :<span class="lineNoCov">          0 :         setZero(x2, 8);</span>
<span class="lineNum">     367 </span>                :<span class="lineNoCov">          0 :         x1[0]=1; </span>
<span class="lineNum">     368 </span>                :            :         /* While u !=1 and v !=1 */ 
<span class="lineNum">     369 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while ((isOne(u) || isOne(v))==0) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">     370 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 while(!(u[0]&amp;1)) {                                  /* While u is even */</span>
<span class="lineNum">     371 </span>                :<span class="lineNoCov">          0 :                         rshift(u);                                              /* divide by 2 */</span>
<span class="lineNum">     372 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (!(x1[0]&amp;1))                                     /*ifx1iseven*/</span>
<span class="lineNum">     373 </span>                :<span class="lineNoCov">          0 :                                 rshift(x1);                                     /* Divide by 2 */</span>
<span class="lineNum">     374 </span>                :            :                         else {
<span class="lineNum">     375 </span>                :<span class="lineNoCov">          0 :                                 fieldAddAndDivide(x1,modulus,reducer,tempm); /* tempm=x1+p */</span>
<span class="lineNum">     376 </span>                :<span class="lineNoCov">          0 :                                 copy(tempm,x1,arrayLength);             /* x1=tempm */</span>
<span class="lineNum">     377 </span>                :            :                                 //rshift(x1);                                   /* Divide by 2 */
<span class="lineNum">     378 </span>                :            :                         }
<span class="lineNum">     379 </span>                :            :                 } 
<span class="lineNum">     380 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 while(!(v[0]&amp;1)) {                                  /* While v is even */</span>
<span class="lineNum">     381 </span>                :<span class="lineNoCov">          0 :                         rshift(v);                                              /* divide by 2 */ </span>
<span class="lineNum">     382 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (!(x2[0]&amp;1))                                     /*ifx1iseven*/</span>
<span class="lineNum">     383 </span>                :<span class="lineNoCov">          0 :                                 rshift(x2);                             /* Divide by 2 */</span>
<span class="lineNum">     384 </span>                :            :                         else
<span class="lineNum">     385 </span>                :            :                         {
<span class="lineNum">     386 </span>                :<span class="lineNoCov">          0 :                                 fieldAddAndDivide(x2,modulus,reducer,tempm);    /* tempm=x1+p */</span>
<span class="lineNum">     387 </span>                :<span class="lineNoCov">          0 :                                 copy(tempm,x2,arrayLength);                     /* x1=tempm */ </span>
<span class="lineNum">     388 </span>                :            :                                 //rshift(x2);                                   /* Divide by 2 */
<span class="lineNum">     389 </span>                :            :                         }
<span class="lineNum">     390 </span>                :            :                         
<span class="lineNum">     391 </span>                :            :                 } 
<span class="lineNum">     392 </span>                :<span class="lineNoCov">          0 :                 t=sub(u,v,tempm,arrayLength);                           /* tempm=u-v */</span>
<span class="lineNum">     393 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (t==0) {                                                     /* If u &gt; 0 */</span>
<span class="lineNum">     394 </span>                :<span class="lineNoCov">          0 :                         copy(tempm,u,arrayLength);                                      /* u=u-v */</span>
<span class="lineNum">     395 </span>                :<span class="lineNoCov">          0 :                         fieldSub(x1,x2,modulus,tempm);                  /* tempm=x1-x2 */</span>
<span class="lineNum">     396 </span>                :<span class="lineNoCov">          0 :                         copy(tempm,x1,arrayLength);                                     /* x1=x1-x2 */</span>
<span class="lineNum">     397 </span>                :            :                 } else {
<span class="lineNum">     398 </span>                :<span class="lineNoCov">          0 :                         sub(v,u,tempm,arrayLength);                     /* tempm=v-u */</span>
<span class="lineNum">     399 </span>                :<span class="lineNoCov">          0 :                         copy(tempm,v,arrayLength);                                      /* v=v-u */</span>
<span class="lineNum">     400 </span>                :<span class="lineNoCov">          0 :                         fieldSub(x2,x1,modulus,tempm);                  /* tempm=x2-x1 */</span>
<span class="lineNum">     401 </span>                :<span class="lineNoCov">          0 :                         copy(tempm,x2,arrayLength);                                     /* x2=x2-x1 */</span>
<span class="lineNum">     402 </span>                :            :                 }
<span class="lineNum">     403 </span>                :            :         } 
<span class="lineNum">     404 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (isOne(u)) {</span>
<span class="lineNum">     405 </span>                :<span class="lineNoCov">          0 :                 copy(x1,B,arrayLength); </span>
<span class="lineNum">     406 </span>                :            :         } else {
<span class="lineNum">     407 </span>                :<span class="lineNoCov">          0 :                 copy(x2,B,arrayLength);</span>
<span class="lineNum">     408 </span>                :            :         }
<a name="409"><span class="lineNum">     409 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     410 </span>                :            : 
<span class="lineNum">     411 </span>                :<span class="lineNoCov">          0 : void static ec_double(const uint32_t *px, const uint32_t *py, uint32_t *Dx, uint32_t *Dy){</span>
<span class="lineNum">     412 </span>                :            :         uint32_t tempA[8];
<span class="lineNum">     413 </span>                :            :         uint32_t tempB[8];
<span class="lineNum">     414 </span>                :            :         uint32_t tempC[8];
<span class="lineNum">     415 </span>                :            :         uint32_t tempD[16];
<span class="lineNum">     416 </span>                :            : 
<span class="lineNum">     417 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(isZero(px) &amp;&amp; isZero(py)){</span>
<span class="lineNum">     418 </span>                :<span class="lineNoCov">          0 :                 copy(px, Dx,arrayLength);</span>
<span class="lineNum">     419 </span>                :<span class="lineNoCov">          0 :                 copy(py, Dy,arrayLength);</span>
<span class="lineNum">     420 </span>                :<span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     421 </span>                :            :         }
<span class="lineNum">     422 </span>                :            : 
<span class="lineNum">     423 </span>                :<span class="lineNoCov">          0 :         fieldMult(px, px, tempD, arrayLength);</span>
<span class="lineNum">     424 </span>                :<span class="lineNoCov">          0 :         fieldModP(tempA, tempD);</span>
<span class="lineNum">     425 </span>                :<span class="lineNoCov">          0 :         setZero(tempB, 8);</span>
<span class="lineNum">     426 </span>                :<span class="lineNoCov">          0 :         tempB[0] = 0x00000001;</span>
<span class="lineNum">     427 </span>                :<span class="lineNoCov">          0 :         fieldSub(tempA, tempB, ecc_prime_m, tempC); //tempC = (qx^2-1)</span>
<span class="lineNum">     428 </span>                :<span class="lineNoCov">          0 :         tempB[0] = 0x00000003;</span>
<span class="lineNum">     429 </span>                :<span class="lineNoCov">          0 :         fieldMult(tempC, tempB, tempD, arrayLength);</span>
<span class="lineNum">     430 </span>                :<span class="lineNoCov">          0 :         fieldModP(tempA, tempD);//tempA = 3*(qx^2-1)</span>
<span class="lineNum">     431 </span>                :<span class="lineNoCov">          0 :         fieldAdd(py, py, ecc_prime_r, tempB); //tempB = 2*qy</span>
<span class="lineNum">     432 </span>                :<span class="lineNoCov">          0 :         fieldInv(tempB, ecc_prime_m, ecc_prime_r, tempC); //tempC = 1/(2*qy)</span>
<span class="lineNum">     433 </span>                :<span class="lineNoCov">          0 :         fieldMult(tempA, tempC, tempD, arrayLength); //tempB = lambda = (3*(qx^2-1))/(2*qy)</span>
<span class="lineNum">     434 </span>                :<span class="lineNoCov">          0 :         fieldModP(tempB, tempD);</span>
<span class="lineNum">     435 </span>                :            : 
<span class="lineNum">     436 </span>                :<span class="lineNoCov">          0 :         fieldMult(tempB, tempB, tempD, arrayLength); //tempC = lambda^2</span>
<span class="lineNum">     437 </span>                :<span class="lineNoCov">          0 :         fieldModP(tempC, tempD);</span>
<span class="lineNum">     438 </span>                :<span class="lineNoCov">          0 :         fieldSub(tempC, px, ecc_prime_m, tempA); //lambda^2 - Px</span>
<span class="lineNum">     439 </span>                :<span class="lineNoCov">          0 :         fieldSub(tempA, px, ecc_prime_m, Dx); //lambda^2 - Px - Qx</span>
<span class="lineNum">     440 </span>                :            : 
<span class="lineNum">     441 </span>                :<span class="lineNoCov">          0 :         fieldSub(px, Dx, ecc_prime_m, tempA); //tempA = qx-dx</span>
<span class="lineNum">     442 </span>                :<span class="lineNoCov">          0 :         fieldMult(tempB, tempA, tempD, arrayLength); //tempC = lambda * (qx-dx)</span>
<span class="lineNum">     443 </span>                :<span class="lineNoCov">          0 :         fieldModP(tempC, tempD);</span>
<span class="lineNum">     444 </span>                :<span class="lineNoCov">          0 :         fieldSub(tempC, py, ecc_prime_m, Dy); //Dy = lambda * (qx-dx) - px</span>
<a name="445"><span class="lineNum">     445 </span>                :            : }</a>
<span class="lineNum">     446 </span>                :            : 
<span class="lineNum">     447 </span>                :<span class="lineNoCov">          0 : void static ec_add(const uint32_t *px, const uint32_t *py, const uint32_t *qx, const uint32_t *qy, uint32_t *Sx, uint32_t *Sy){</span>
<span class="lineNum">     448 </span>                :            :         uint32_t tempA[8];
<span class="lineNum">     449 </span>                :            :         uint32_t tempB[8];
<span class="lineNum">     450 </span>                :            :         uint32_t tempC[8];
<span class="lineNum">     451 </span>                :            :         uint32_t tempD[16];
<span class="lineNum">     452 </span>                :            : 
<span class="lineNum">     453 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(isZero(px) &amp;&amp; isZero(py)){</span>
<span class="lineNum">     454 </span>                :<span class="lineNoCov">          0 :                 copy(qx, Sx,arrayLength);</span>
<span class="lineNum">     455 </span>                :<span class="lineNoCov">          0 :                 copy(qy, Sy,arrayLength);</span>
<span class="lineNum">     456 </span>                :<span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     457 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if(isZero(qx) &amp;&amp; isZero(qy)) {</span>
<span class="lineNum">     458 </span>                :<span class="lineNoCov">          0 :                 copy(px, Sx,arrayLength);</span>
<span class="lineNum">     459 </span>                :<span class="lineNoCov">          0 :                 copy(py, Sy,arrayLength);</span>
<span class="lineNum">     460 </span>                :<span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     461 </span>                :            :         }
<span class="lineNum">     462 </span>                :            : 
<span class="lineNum">     463 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(isSame(px, qx, arrayLength)){</span>
<span class="lineNum">     464 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(!isSame(py, qy, arrayLength)){</span>
<span class="lineNum">     465 </span>                :<span class="lineNoCov">          0 :                         setZero(Sx, 8);</span>
<span class="lineNum">     466 </span>                :<span class="lineNoCov">          0 :                         setZero(Sy, 8);</span>
<span class="lineNum">     467 </span>                :<span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     468 </span>                :            :                 } else {
<span class="lineNum">     469 </span>                :<span class="lineNoCov">          0 :                         ec_double(px, py, Sx, Sy);</span>
<span class="lineNum">     470 </span>                :<span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     471 </span>                :            :                 }
<span class="lineNum">     472 </span>                :            :         }
<span class="lineNum">     473 </span>                :            : 
<span class="lineNum">     474 </span>                :<span class="lineNoCov">          0 :         fieldSub(py, qy, ecc_prime_m, tempA);</span>
<span class="lineNum">     475 </span>                :<span class="lineNoCov">          0 :         fieldSub(px, qx, ecc_prime_m, tempB);</span>
<span class="lineNum">     476 </span>                :<span class="lineNoCov">          0 :         fieldInv(tempB, ecc_prime_m, ecc_prime_r, tempB);</span>
<span class="lineNum">     477 </span>                :<span class="lineNoCov">          0 :         fieldMult(tempA, tempB, tempD, arrayLength); </span>
<span class="lineNum">     478 </span>                :<span class="lineNoCov">          0 :         fieldModP(tempC, tempD); //tempC = lambda</span>
<span class="lineNum">     479 </span>                :            : 
<span class="lineNum">     480 </span>                :<span class="lineNoCov">          0 :         fieldMult(tempC, tempC, tempD, arrayLength); //tempA = lambda^2</span>
<span class="lineNum">     481 </span>                :<span class="lineNoCov">          0 :         fieldModP(tempA, tempD);</span>
<span class="lineNum">     482 </span>                :<span class="lineNoCov">          0 :         fieldSub(tempA, px, ecc_prime_m, tempB); //lambda^2 - Px</span>
<span class="lineNum">     483 </span>                :<span class="lineNoCov">          0 :         fieldSub(tempB, qx, ecc_prime_m, Sx); //lambda^2 - Px - Qx</span>
<span class="lineNum">     484 </span>                :            : 
<span class="lineNum">     485 </span>                :<span class="lineNoCov">          0 :         fieldSub(qx, Sx, ecc_prime_m, tempB);</span>
<span class="lineNum">     486 </span>                :<span class="lineNoCov">          0 :         fieldMult(tempC, tempB, tempD, arrayLength);</span>
<span class="lineNum">     487 </span>                :<span class="lineNoCov">          0 :         fieldModP(tempC, tempD);</span>
<span class="lineNum">     488 </span>                :<span class="lineNoCov">          0 :         fieldSub(tempC, qy, ecc_prime_m, Sy);</span>
<a name="489"><span class="lineNum">     489 </span>                :            : }</a>
<span class="lineNum">     490 </span>                :            : 
<span class="lineNum">     491 </span>                :<span class="lineNoCov">          0 : void ecc_ec_mult(const uint32_t *px, const uint32_t *py, const uint32_t *secret, uint32_t *resultx, uint32_t *resulty){</span>
<span class="lineNum">     492 </span>                :            :         uint32_t Qx[8];
<span class="lineNum">     493 </span>                :            :         uint32_t Qy[8];
<span class="lineNum">     494 </span>                :<span class="lineNoCov">          0 :         setZero(Qx, 8);</span>
<span class="lineNum">     495 </span>                :<span class="lineNoCov">          0 :         setZero(Qy, 8);</span>
<span class="lineNum">     496 </span>                :            : 
<span class="lineNum">     497 </span>                :            :         uint32_t tempx[8];
<span class="lineNum">     498 </span>                :            :         uint32_t tempy[8];
<span class="lineNum">     499 </span>                :            : 
<span class="lineNum">     500 </span>                :            :         int i;
<span class="lineNum">     501 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (i = 256;i--;){</span>
<span class="lineNum">     502 </span>                :<span class="lineNoCov">          0 :                 ec_double(Qx, Qy, tempx, tempy);</span>
<span class="lineNum">     503 </span>                :<span class="lineNoCov">          0 :                 copy(tempx, Qx,arrayLength);</span>
<span class="lineNum">     504 </span>                :<span class="lineNoCov">          0 :                 copy(tempy, Qy,arrayLength);</span>
<span class="lineNum">     505 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (((secret[i / 32]) &amp; ((uint32_t)1 &lt;&lt; (i % 32)))) {</span>
<span class="lineNum">     506 </span>                :<span class="lineNoCov">          0 :                         ec_add(Qx, Qy, px, py, tempx, tempy); //eccAdd</span>
<span class="lineNum">     507 </span>                :<span class="lineNoCov">          0 :                         copy(tempx, Qx,arrayLength);</span>
<span class="lineNum">     508 </span>                :<span class="lineNoCov">          0 :                         copy(tempy, Qy,arrayLength);</span>
<span class="lineNum">     509 </span>                :            :                 }
<span class="lineNum">     510 </span>                :            :         }
<span class="lineNum">     511 </span>                :<span class="lineNoCov">          0 :         copy(Qx, resultx,arrayLength);</span>
<span class="lineNum">     512 </span>                :<span class="lineNoCov">          0 :         copy(Qy, resulty,arrayLength);</span>
<span class="lineNum">     513 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     514 </span>                :            : 
<span class="lineNum">     515 </span>                :            : /**
<span class="lineNum">     516 </span>                :            :  * Calculate the ecdsa signature.
<span class="lineNum">     517 </span>                :            :  *
<span class="lineNum">     518 </span>                :            :  * For a description of this algorithm see
<span class="lineNum">     519 </span>                :            :  * https://en.wikipedia.org/wiki/Elliptic_Curve_DSA#Signature_generation_algorithm
<span class="lineNum">     520 </span>                :            :  *
<span class="lineNum">     521 </span>                :            :  * input:
<span class="lineNum">     522 </span>                :            :  *  d: private key on the curve secp256r1 (32 bytes)
<span class="lineNum">     523 </span>                :            :  *  e: hash to sign (32 bytes)
<span class="lineNum">     524 </span>                :            :  *  k: random data, this must be changed for every signature (32 bytes)
<span class="lineNum">     525 </span>                :            :  *
<span class="lineNum">     526 </span>                :            :  * output:
<span class="lineNum">     527 </span>                :            :  *  r: r value of the signature (36 bytes)
<span class="lineNum">     528 </span>                :            :  *  s: s value of the signature (36 bytes)
<span class="lineNum">     529 </span>                :            :  *
<span class="lineNum">     530 </span>                :            :  * return:
<span class="lineNum">     531 </span>                :            :  *   0: everything is ok
<a name="532"><span class="lineNum">     532 </span>                :            :  *  -1: can not create signature, try again with different k.</a>
<span class="lineNum">     533 </span>                :            :  */
<span class="lineNum">     534 </span>                :<span class="lineNoCov">          0 : int ecc_ecdsa_sign_hash(const uint32_t *d, const uint32_t *e, const uint32_t *k, uint32_t *r, uint32_t *s)</span>
<span class="lineNum">     535 </span>                :            : {
<span class="lineNum">     536 </span>                :            :         uint32_t tmp1[16];
<span class="lineNum">     537 </span>                :            :         uint32_t tmp2[9];
<span class="lineNum">     538 </span>                :            :         uint32_t tmp3[9];
<span class="lineNum">     539 </span>                :            : 
<span class="lineNum">     540 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (isZero(k))</span>
<span class="lineNum">     541 </span>                :<span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     542 </span>                :            : 
<span class="lineNum">     543 </span>                :            :         // 4. Calculate the curve point (x_1, y_1) = k * G.
<span class="lineNum">     544 </span>                :<span class="lineNoCov">          0 :         ecc_ec_mult(ecc_g_point_x, ecc_g_point_y, k, r, tmp1);</span>
<span class="lineNum">     545 </span>                :            : 
<span class="lineNum">     546 </span>                :            :         // 5. Calculate r = x_1 \pmod{n}.
<span class="lineNum">     547 </span>                :<span class="lineNoCov">          0 :         fieldModO(r, r, 8);</span>
<span class="lineNum">     548 </span>                :            : 
<span class="lineNum">     549 </span>                :            :         // 5. If r = 0, go back to step 3.
<span class="lineNum">     550 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (isZero(r))</span>
<span class="lineNum">     551 </span>                :<span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     552 </span>                :            : 
<span class="lineNum">     553 </span>                :            :         // 6. Calculate s = k^{-1}(z + r d_A) \pmod{n}.
<span class="lineNum">     554 </span>                :            :         // 6. r * d
<span class="lineNum">     555 </span>                :<span class="lineNoCov">          0 :         fieldMult(r, d, tmp1, arrayLength);</span>
<span class="lineNum">     556 </span>                :<span class="lineNoCov">          0 :         fieldModO(tmp1, tmp2, 16);</span>
<span class="lineNum">     557 </span>                :            : 
<span class="lineNum">     558 </span>                :            :         // 6. z + (r d)
<span class="lineNum">     559 </span>                :<span class="lineNoCov">          0 :         tmp1[8] = add(e, tmp2, tmp1, 8);</span>
<span class="lineNum">     560 </span>                :<span class="lineNoCov">          0 :         fieldModO(tmp1, tmp3, 9);</span>
<span class="lineNum">     561 </span>                :            : 
<span class="lineNum">     562 </span>                :            :         // 6. k^{-1}
<span class="lineNum">     563 </span>                :<span class="lineNoCov">          0 :         fieldInv(k, ecc_order_m, ecc_order_r, tmp2);</span>
<span class="lineNum">     564 </span>                :            : 
<span class="lineNum">     565 </span>                :            :         // 6. (k^{-1}) (z + (r d))
<span class="lineNum">     566 </span>                :<span class="lineNoCov">          0 :         fieldMult(tmp2, tmp3, tmp1, arrayLength);</span>
<span class="lineNum">     567 </span>                :<span class="lineNoCov">          0 :         fieldModO(tmp1, s, 16);</span>
<span class="lineNum">     568 </span>                :            : 
<span class="lineNum">     569 </span>                :            :         // 6. If s = 0, go back to step 3.
<span class="lineNum">     570 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (isZero(s))</span>
<span class="lineNum">     571 </span>                :<span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     572 </span>                :            : 
<span class="lineNum">     573 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     574 </span>                :            : }
<span class="lineNum">     575 </span>                :            : 
<span class="lineNum">     576 </span>                :            : /**
<span class="lineNum">     577 </span>                :            :  * Verifies a ecdsa signature.
<span class="lineNum">     578 </span>                :            :  *
<span class="lineNum">     579 </span>                :            :  * For a description of this algorithm see
<span class="lineNum">     580 </span>                :            :  * https://en.wikipedia.org/wiki/Elliptic_Curve_DSA#Signature_verification_algorithm
<span class="lineNum">     581 </span>                :            :  *
<span class="lineNum">     582 </span>                :            :  * input:
<span class="lineNum">     583 </span>                :            :  *  x: x coordinate of the public key (32 bytes)
<span class="lineNum">     584 </span>                :            :  *  y: y coordinate of the public key (32 bytes)
<span class="lineNum">     585 </span>                :            :  *  e: hash to verify the signature of (32 bytes)
<span class="lineNum">     586 </span>                :            :  *  r: r value of the signature (32 bytes)
<span class="lineNum">     587 </span>                :            :  *  s: s value of the signature (32 bytes)
<span class="lineNum">     588 </span>                :            :  *
<span class="lineNum">     589 </span>                :            :  * return:
<span class="lineNum">     590 </span>                :            :  *  0: signature is ok
<a name="591"><span class="lineNum">     591 </span>                :            :  *  -1: signature check failed the signature is invalid</a>
<span class="lineNum">     592 </span>                :            :  */
<span class="lineNum">     593 </span>                :<span class="lineNoCov">          0 : int ecc_ecdsa_validate(const uint32_t *x, const uint32_t *y, const uint32_t *e, const uint32_t *r, const uint32_t *s)</span>
<span class="lineNum">     594 </span>                :            : {
<span class="lineNum">     595 </span>                :            :         uint32_t w[8];
<span class="lineNum">     596 </span>                :            :         uint32_t tmp[16];
<span class="lineNum">     597 </span>                :            :         uint32_t u1[9];
<span class="lineNum">     598 </span>                :            :         uint32_t u2[9];
<span class="lineNum">     599 </span>                :            :         uint32_t tmp1_x[8];
<span class="lineNum">     600 </span>                :            :         uint32_t tmp1_y[8];
<span class="lineNum">     601 </span>                :            :         uint32_t tmp2_x[8];
<span class="lineNum">     602 </span>                :            :         uint32_t tmp2_y[8];
<span class="lineNum">     603 </span>                :            :         uint32_t tmp3_x[8];
<span class="lineNum">     604 </span>                :            :         uint32_t tmp3_y[8];
<span class="lineNum">     605 </span>                :            : 
<span class="lineNum">     606 </span>                :            :         // 3. Calculate w = s^{-1} \pmod{n}
<span class="lineNum">     607 </span>                :<span class="lineNoCov">          0 :         fieldInv(s, ecc_order_m, ecc_order_r, w);</span>
<span class="lineNum">     608 </span>                :            : 
<span class="lineNum">     609 </span>                :            :         // 4. Calculate u_1 = zw \pmod{n}
<span class="lineNum">     610 </span>                :<span class="lineNoCov">          0 :         fieldMult(e, w, tmp, arrayLength);</span>
<span class="lineNum">     611 </span>                :<span class="lineNoCov">          0 :         fieldModO(tmp, u1, 16);</span>
<span class="lineNum">     612 </span>                :            : 
<span class="lineNum">     613 </span>                :            :         // 4. Calculate u_2 = rw \pmod{n}
<span class="lineNum">     614 </span>                :<span class="lineNoCov">          0 :         fieldMult(r, w, tmp, arrayLength);</span>
<span class="lineNum">     615 </span>                :<span class="lineNoCov">          0 :         fieldModO(tmp, u2, 16);</span>
<span class="lineNum">     616 </span>                :            : 
<span class="lineNum">     617 </span>                :            :         // 5. Calculate the curve point (x_1, y_1) = u_1 * G + u_2 * Q_A.
<span class="lineNum">     618 </span>                :            :         // tmp1 = u_1 * G
<span class="lineNum">     619 </span>                :<span class="lineNoCov">          0 :         ecc_ec_mult(ecc_g_point_x, ecc_g_point_y, u1, tmp1_x, tmp1_y);</span>
<span class="lineNum">     620 </span>                :            : 
<span class="lineNum">     621 </span>                :            :         // tmp2 = u_2 * Q_A
<span class="lineNum">     622 </span>                :<span class="lineNoCov">          0 :         ecc_ec_mult(x, y, u2, tmp2_x, tmp2_y);</span>
<span class="lineNum">     623 </span>                :            : 
<span class="lineNum">     624 </span>                :            :         // tmp3 = tmp1 + tmp2
<span class="lineNum">     625 </span>                :<span class="lineNoCov">          0 :         ec_add(tmp1_x, tmp1_y, tmp2_x, tmp2_y, tmp3_x, tmp3_y);</span>
<span class="lineNum">     626 </span>                :            :         // TODO: this u_1 * G + u_2 * Q_A  could be optimiced with Straus's algorithm.
<span class="lineNum">     627 </span>                :            : 
<span class="lineNum">     628 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return isSame(tmp3_x, r, arrayLength) ? 0 : -1;</span>
<a name="629"><span class="lineNum">     629 </span>                :            : }</a>
<span class="lineNum">     630 </span>                :            : 
<span class="lineNum">     631 </span>                :<span class="lineNoCov">          0 : int ecc_is_valid_key(const uint32_t * priv_key)</span>
<span class="lineNum">     632 </span>                :            : {
<span class="lineNum">     633 </span>                :<span class="lineNoCov">          0 :         return isGreater(ecc_order_m, priv_key, arrayLength) == 1;</span>
<span class="lineNum">     634 </span>                :            : }
<span class="lineNum">     635 </span>                :            : 
<span class="lineNum">     636 </span>                :            : /*
<span class="lineNum">     637 </span>                :            :  * This exports the low level functions so the tests can use them.
<span class="lineNum">     638 </span>                :            :  * In real use the compiler is now bale to optimice the code better.
<span class="lineNum">     639 </span>                :            :  */
<span class="lineNum">     640 </span>                :            : #ifdef TEST_INCLUDE
<span class="lineNum">     641 </span>                :            : uint32_t ecc_add( const uint32_t *x, const uint32_t *y, uint32_t *result, uint8_t length)
<span class="lineNum">     642 </span>                :            : {
<span class="lineNum">     643 </span>                :            :         return add(x, y, result, length);
<span class="lineNum">     644 </span>                :            : }
<span class="lineNum">     645 </span>                :            : uint32_t ecc_sub( const uint32_t *x, const uint32_t *y, uint32_t *result, uint8_t length)
<span class="lineNum">     646 </span>                :            : {
<span class="lineNum">     647 </span>                :            :         return sub(x, y, result, length);
<span class="lineNum">     648 </span>                :            : }
<span class="lineNum">     649 </span>                :            : int ecc_fieldAdd(const uint32_t *x, const uint32_t *y, const uint32_t *reducer, uint32_t *result)
<span class="lineNum">     650 </span>                :            : {
<span class="lineNum">     651 </span>                :            :         return fieldAdd(x, y, reducer, result);
<span class="lineNum">     652 </span>                :            : }
<span class="lineNum">     653 </span>                :            : int ecc_fieldSub(const uint32_t *x, const uint32_t *y, const uint32_t *modulus, uint32_t *result)
<span class="lineNum">     654 </span>                :            : {
<span class="lineNum">     655 </span>                :            :         return fieldSub(x, y, modulus, result);
<span class="lineNum">     656 </span>                :            : }
<span class="lineNum">     657 </span>                :            : int ecc_fieldMult(const uint32_t *x, const uint32_t *y, uint32_t *result, uint8_t length)
<span class="lineNum">     658 </span>                :            : {
<span class="lineNum">     659 </span>                :            :         return fieldMult(x, y, result, length);
<span class="lineNum">     660 </span>                :            : }
<span class="lineNum">     661 </span>                :            : void ecc_fieldModP(uint32_t *A, const uint32_t *B)
<span class="lineNum">     662 </span>                :            : {
<span class="lineNum">     663 </span>                :            :         fieldModP(A, B);
<span class="lineNum">     664 </span>                :            : }
<span class="lineNum">     665 </span>                :            : void ecc_fieldModO(const uint32_t *A, uint32_t *result, uint8_t length)
<span class="lineNum">     666 </span>                :            : {
<span class="lineNum">     667 </span>                :            :         fieldModO(A, result, length);
<span class="lineNum">     668 </span>                :            : }
<span class="lineNum">     669 </span>                :            : void ecc_fieldInv(const uint32_t *A, const uint32_t *modulus, const uint32_t *reducer, uint32_t *B)
<span class="lineNum">     670 </span>                :            : {
<span class="lineNum">     671 </span>                :            :         fieldInv(A, modulus, reducer, B);
<span class="lineNum">     672 </span>                :            : }
<span class="lineNum">     673 </span>                :            : void ecc_copy(const uint32_t *from, uint32_t *to, uint8_t length)
<span class="lineNum">     674 </span>                :            : {
<span class="lineNum">     675 </span>                :            :         copy(from, to, length);
<span class="lineNum">     676 </span>                :            : }
<span class="lineNum">     677 </span>                :            : int ecc_isSame(const uint32_t *A, const uint32_t *B, uint8_t length)
<span class="lineNum">     678 </span>                :            : {
<span class="lineNum">     679 </span>                :            :         return isSame(A, B, length);
<span class="lineNum">     680 </span>                :            : }
<span class="lineNum">     681 </span>                :            : void ecc_setZero(uint32_t *A, const int length)
<span class="lineNum">     682 </span>                :            : {
<span class="lineNum">     683 </span>                :            :         setZero(A, length);
<span class="lineNum">     684 </span>                :            : }
<span class="lineNum">     685 </span>                :            : int ecc_isOne(const uint32_t* A)
<span class="lineNum">     686 </span>                :            : {
<span class="lineNum">     687 </span>                :            :         return isOne(A);
<span class="lineNum">     688 </span>                :            : }
<span class="lineNum">     689 </span>                :            : void ecc_rshift(uint32_t* A)
<span class="lineNum">     690 </span>                :            : {
<span class="lineNum">     691 </span>                :            :         rshift(A);
<span class="lineNum">     692 </span>                :            : }
<span class="lineNum">     693 </span>                :            : int ecc_isGreater(const uint32_t *A, const uint32_t *B, uint8_t length)
<span class="lineNum">     694 </span>                :            : {
<span class="lineNum">     695 </span>                :            :         return isGreater(A, B , length);
<span class="lineNum">     696 </span>                :            : }
<span class="lineNum">     697 </span>                :            : 
<span class="lineNum">     698 </span>                :            : void ecc_ec_add(const uint32_t *px, const uint32_t *py, const uint32_t *qx, const uint32_t *qy, uint32_t *Sx, uint32_t *Sy)
<span class="lineNum">     699 </span>                :            : {
<span class="lineNum">     700 </span>                :            :         ec_add(px, py, qx, qy, Sx, Sy);
<span class="lineNum">     701 </span>                :            : }
<span class="lineNum">     702 </span>                :            : void ecc_ec_double(const uint32_t *px, const uint32_t *py, uint32_t *Dx, uint32_t *Dy)
<span class="lineNum">     703 </span>                :            : {
<span class="lineNum">     704 </span>                :            :         ec_double(px, py, Dx, Dy);
<span class="lineNum">     705 </span>                :            : }
<span class="lineNum">     706 </span>                :            : 
<span class="lineNum">     707 </span>                :            : #endif /* TEST_INCLUDE */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
